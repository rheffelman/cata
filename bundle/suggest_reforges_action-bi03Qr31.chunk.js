import{fz as t,fA as e,ad as s,S as a,af as i,T as r,bw as n,q as o,u as l,s as u,cE as p,cI as c,fB as h,cG as f,al as d,fC as m,x as g}from"./detailed_results-C-DDAdQD.chunk.js";import{t as b}from"./index-CxS5KVR3.chunk.js";import{ab as y,ag as w}from"./preset_utils-DkHhB_Bm.chunk.js";const S=t=>({min:t}),v=(t,e,s)=>t.matrix[Math.imul(e,t.width)+s],C=(t,e,s,a)=>{t.matrix[Math.imul(e,t.width)+s]=a},P=t=>"function"==typeof t[Symbol.iterator]?t:Object.entries(t),N=t=>!0===t||(!1===t?new Set:t instanceof Set?t:new Set(t)),x=(t,e)=>{const s=Math.round(1/e);return Math.round((t+Number.EPSILON)*s)/s},E=(t,e,s)=>{const a=v(t,e,s),i=t.variableAtPosition[t.width+e],r=t.variableAtPosition[s];t.variableAtPosition[t.width+e]=r,t.variableAtPosition[s]=i,t.positionOfVariable[i]=s,t.positionOfVariable[r]=t.width+e;const n=[];for(let o=0;o<t.width;o++){const s=v(t,e,o);Math.abs(s)>1e-16?(C(t,e,o,s/a),n.push(o)):C(t,e,o,0)}C(t,e,s,1/a);for(let o=0;o<t.height;o++){if(o===e)continue;const i=v(t,o,s);if(Math.abs(i)>1e-16){for(let s=0;s<n.length;s++){const a=n[s];C(t,o,a,v(t,o,a)-i*v(t,e,a))}C(t,o,s,-i/a)}}},M=(t,e,s,a)=>{t.push([e.variableAtPosition[e.width+s],e.variableAtPosition[a]]);for(let i=6;i<=Math.trunc(t.length/2);i++){let e=!0;for(let s=0;s<i;s++){const a=t.length-1-s,[r,n]=t[a],[o,l]=t[a-i];if(r!==o||n!==l){e=!1;break}}if(e)return!0}return!1},A=(t,e)=>{const s=[],{precision:a,maxPivots:i,checkCycles:r}=e;for(let n=0;n<i;n++){let e=0,i=a;for(let s=1;s<t.width;s++){const a=v(t,0,s);a>i&&(i=a,e=s)}if(0===e)return["optimal",x(v(t,0,0),a)];let n=0,o=1/0;for(let s=1;s<t.height;s++){const i=v(t,s,e);if(i<=a)continue;const r=v(t,s,0)/i;if(r<o&&(n=s,o=r,r<=a))break}if(0===n)return["unbounded",e];if(r&&M(s,t,n,e))return["cycled",NaN];E(t,n,e)}return["cycled",NaN]},I=(t,e)=>{const s=[],{precision:a,maxPivots:i,checkCycles:r}=e;for(let n=0;n<i;n++){let i=0,n=-a;for(let e=1;e<t.height;e++){const s=v(t,e,0);s<n&&(n=s,i=e)}if(0===i)return A(t,e);let o=0,l=-1/0;for(let e=1;e<t.width;e++){const s=v(t,i,e);if(s<-a){const a=-v(t,0,e)/s;a>l&&(l=a,o=e)}}if(0===o)return["infeasible",NaN];if(r&&M(s,t,i,o))return["cycled",NaN];E(t,i,o)}return["cycled",NaN]};var V,k={exports:{}};V=k,function(){var t,e,s,a,i,r,n,o,l,u,p,c,h,f,d;s=Math.floor,u=Math.min,e=function(t,e){return t<e?-1:t>e?1:0},l=function(t,a,i,r,n){var o;if(null==i&&(i=0),null==n&&(n=e),i<0)throw new Error("lo must be non-negative");for(null==r&&(r=t.length);i<r;)n(a,t[o=s((i+r)/2)])<0?r=o:i=o+1;return[].splice.apply(t,[i,i-i].concat(a)),a},r=function(t,s,a){return null==a&&(a=e),t.push(s),f(t,0,t.length-1,a)},i=function(t,s){var a,i;return null==s&&(s=e),a=t.pop(),t.length?(i=t[0],t[0]=a,d(t,0,s)):i=a,i},o=function(t,s,a){var i;return null==a&&(a=e),i=t[0],t[0]=s,d(t,0,a),i},n=function(t,s,a){var i;return null==a&&(a=e),t.length&&a(t[0],s)<0&&(s=(i=[t[0],s])[0],t[0]=i[1],d(t,0,a)),s},a=function(t,a){var i,r,n,o,l,u;for(null==a&&(a=e),l=[],r=0,n=(o=function(){u=[];for(var e=0,a=s(t.length/2);0<=a?e<a:e>a;0<=a?e++:e--)u.push(e);return u}.apply(this).reverse()).length;r<n;r++)i=o[r],l.push(d(t,i,a));return l},h=function(t,s,a){var i;if(null==a&&(a=e),-1!==(i=t.indexOf(s)))return f(t,0,i,a),d(t,i,a)},p=function(t,s,i){var r,o,l,u,p;if(null==i&&(i=e),!(o=t.slice(0,s)).length)return o;for(a(o,i),l=0,u=(p=t.slice(s)).length;l<u;l++)r=p[l],n(o,r,i);return o.sort(i).reverse()},c=function(t,s,r){var n,o,p,c,h,f,d,m,g;if(null==r&&(r=e),10*s<=t.length){if(!(p=t.slice(0,s).sort(r)).length)return p;for(o=p[p.length-1],c=0,f=(d=t.slice(s)).length;c<f;c++)r(n=d[c],o)<0&&(l(p,n,0,null,r),p.pop(),o=p[p.length-1]);return p}for(a(t,r),g=[],h=0,m=u(s,t.length);0<=m?h<m:h>m;0<=m?++h:--h)g.push(i(t,r));return g},f=function(t,s,a,i){var r,n,o;for(null==i&&(i=e),r=t[a];a>s&&i(r,n=t[o=a-1>>1])<0;)t[a]=n,a=o;return t[a]=r},d=function(t,s,a){var i,r,n,o,l;for(null==a&&(a=e),r=t.length,l=s,n=t[s],i=2*s+1;i<r;)(o=i+1)<r&&!(a(t[i],t[o])<0)&&(i=o),t[s]=t[i],i=2*(s=i)+1;return t[s]=n,f(t,l,s,a)},t=function(){function t(t){this.cmp=null!=t?t:e,this.nodes=[]}return t.push=r,t.pop=i,t.replace=o,t.pushpop=n,t.heapify=a,t.updateItem=h,t.nlargest=p,t.nsmallest=c,t.prototype.push=function(t){return r(this.nodes,t,this.cmp)},t.prototype.pop=function(){return i(this.nodes,this.cmp)},t.prototype.peek=function(){return this.nodes[0]},t.prototype.contains=function(t){return-1!==this.nodes.indexOf(t)},t.prototype.replace=function(t){return o(this.nodes,t,this.cmp)},t.prototype.pushpop=function(t){return n(this.nodes,t,this.cmp)},t.prototype.heapify=function(){return a(this.nodes,this.cmp)},t.prototype.updateItem=function(t){return h(this.nodes,t,this.cmp)},t.prototype.clear=function(){return this.nodes=[]},t.prototype.empty=function(){return 0===this.nodes.length},t.prototype.size=function(){return this.nodes.length},t.prototype.clone=function(){var e;return(e=new t).nodes=this.nodes.slice(0),e},t.prototype.toArray=function(){return this.nodes.slice(0)},t.prototype.insert=t.prototype.push,t.prototype.top=t.prototype.peek,t.prototype.front=t.prototype.peek,t.prototype.has=t.prototype.contains,t.prototype.copy=t.prototype.clone,t}(),V.exports=t}.call(t);const O=e(k.exports),R=(t,e)=>({matrix:new Float64Array(t),positionOfVariable:new Int32Array(e),variableAtPosition:new Int32Array(e)}),D=(t,{matrix:e,positionOfVariable:s,variableAtPosition:a},i)=>{const{width:r,height:n}=t;e.set(t.matrix);for(let l=0;l<i.length;l++){const[s,a,o]=i[l],u=(n+l)*r,p=t.positionOfVariable[a];if(p<r)e[u]=s*o,e.fill(0,u+1,u+r),e[u+p]=s;else{const t=(p-r)*r;e[u]=s*(o-e[t]);for(let a=1;a<r;a++)e[u+a]=-s*e[t+a]}}s.set(t.positionOfVariable),a.set(t.variableAtPosition);const o=r+n+i.length;for(let l=r+n;l<o;l++)s[l]=l,a[l]=l;return{matrix:e.subarray(0,t.matrix.length+r*i.length),width:r,height:n+i.length,positionOfVariable:s.subarray(0,o),variableAtPosition:a.subarray(0,o)}},z=(t,e)=>{let s=0,a=0,i=0;for(let r=0;r<e.length;r++){const n=e[r],o=t.positionOfVariable[n]-t.width;if(o<0)continue;const l=v(t,o,0),u=Math.abs(l-Math.round(l));u>s&&(s=u,a=n,i=l)}return[a,i,s]},F=({tableau:t,sign:e,variables:s},a,i,{precision:r,includeZeroVariables:n})=>{if("optimal"===a||"timedout"===a&&!Number.isNaN(i)){const o=[];for(let e=0;e<s.length;e++){const[a]=s[e],i=t.positionOfVariable[e+1]-t.width,l=i>=0?v(t,i,0):0;l>r?o.push([a,x(l,r)]):n&&o.push([a,0])}return{status:a,result:-e*i,variables:o}}if("unbounded"===a){const a=t.variableAtPosition[i]-1;return{status:"unbounded",result:e*(1/0),variables:0<=a&&a<s.length?[[s[a][0],1/0]]:[]}}return{status:a,result:NaN,variables:[]}},G={precision:1e-8,checkCycles:!1,maxPivots:8192,tolerance:0,timeout:1/0,maxIterations:32768,includeZeroVariables:!1},U=(t,e)=>{const s=(t=>{const{direction:e,objective:s,integers:a,binaries:i}=t,r="minimize"===e?-1:1,n=P(t.constraints),o=P(t.variables),l=Array.isArray(o)?o:Array.from(o),u=[],p=[];if(null!=a||null!=i){const t=N(i),e=!0===t||N(a);for(let s=1;s<=l.length;s++){const[a]=l[s-1];!0===t||t.has(a)?(u.push(s),p.push(s)):(!0===e||e.has(a))&&p.push(s)}}const c=new Map;for(const[S,v]of n){const t=c.get(S)??{row:NaN,lower:-1/0,upper:1/0};t.lower=Math.max(t.lower,v.equal??v.min??-1/0),t.upper=Math.min(t.upper,v.equal??v.max??1/0),c.has(S)||c.set(S,t)}let h=1;for(const S of c.values())S.row=h,h+=(Number.isFinite(S.lower)?1:0)+(Number.isFinite(S.upper)?1:0);const f=l.length+1,d=h+u.length,m=f+d,g=new Float64Array(f*d),b=new Int32Array(m),y=new Int32Array(m),w={matrix:g,width:f,height:d,positionOfVariable:b,variableAtPosition:y};for(let S=0;S<m;S++)b[S]=S,y[S]=S;for(let S=1;S<f;S++)for(const[t,e]of P(l[S-1][1])){t===s&&C(w,0,S,r*e);const a=c.get(t);null!=a&&(Number.isFinite(a.upper)?(C(w,a.row,S,e),Number.isFinite(a.lower)&&C(w,a.row+1,S,-e)):Number.isFinite(a.lower)&&C(w,a.row,S,-e))}for(const S of c.values())Number.isFinite(S.upper)?(C(w,S.row,0,S.upper),Number.isFinite(S.lower)&&C(w,S.row+1,0,-S.lower)):Number.isFinite(S.lower)&&C(w,S.row,0,-S.lower);for(let S=0;S<u.length;S++){const t=h+S;C(w,t,0,1),C(w,t,u[S],1)}return{tableau:w,sign:r,variables:l,integers:p}})(t),a={...G,...e},[i,r]=I(s.tableau,a);if(0===s.integers.length||"optimal"!==i)return F(s,i,r,a);{const[t,e,i]=((t,e,s)=>{const{tableau:a,sign:i,integers:r}=t,{precision:n,maxIterations:o,tolerance:l,timeout:u}=s,[p,c,h]=z(a,r);if(h<=n)return[t,"optimal",e];const f=new O(((t,e)=>t[0]-e[0]));f.push([e,[[-1,p,Math.ceil(c)]]]),f.push([e,[[1,p,Math.floor(c)]]]);const d=2*r.length,m=a.matrix.length+d*a.width,g=a.positionOfVariable.length+d;let b=R(m,g),y=R(m,g);const w=e*(1-i*l),S=u+Date.now();let v=Date.now()>=S,C=!1,P=1/0,N=a,x=0;for(;x<o&&!f.empty()&&P>=w&&!v;){const[t,e]=f.pop();if(t>P)break;const i=D(a,b,e),[o,l]=I(i,s);if("optimal"===o&&l<P){const[t,s,a]=z(i,r);if(a<=n){C=!0,P=l,N=i;const t=y;y=b,b=t}else{const a=[],i=[];for(let s=0;s<e.length;s++){const r=e[s],[n,o]=r;o===t?n<0?i.push(r):a.push(r):(a.push(r),i.push(r))}i.push([1,t,Math.floor(s)]),a.push([-1,t,Math.ceil(s)]),f.push([l,a]),f.push([l,i])}}v=Date.now()>=S,x++}const E=(v||x>=o)&&!f.empty()&&P>=w?"timedout":C?"optimal":"infeasible";return[{...t,tableau:N},E,C?P:NaN]})(s,r,a);return F(t,e,i,a)}},_=[s.StatStamina,s.StatHealth,s.StatStrength,s.StatAgility,s.StatAttackPower,s.StatRangedAttackPower,s.StatIntellect,s.StatSpellPower,s.StatSpellPenetration,s.StatSpirit,s.StatMana];class H{constructor(t,e){this.simUI=t,this.player=t.player,this.isHybridCaster=[a.SpecBalanceDruid,a.SpecShadowPriest,a.SpecElementalShaman].includes(this.player.getSpec()),this.sim=t.sim,this.defaults=t.individualConfig.defaults,this.updateGearStatsModifier=e?.updateGearStatsModifier,this._statCaps=this.statCaps;const s={label:"Suggest Reforges",cssClass:"suggest-reforges-action-button flex-grow-1",onClick:async({currentTarget:t})=>{const e=t;e&&(e.classList.add("loading"),e.disabled=!0);try{performance.mark("reforge-optimization-start"),await this.optimizeReforges(),new w({variant:"success",body:"Reforge optimization complete!"})}catch{new w({variant:"error",body:"Reforge optimization failed. Please try again, or report the issue if it persists."})}finally{performance.mark("reforge-optimization-end"),e&&(e.classList.remove("loading"),e.disabled=!1)}}},i={cssClass:"suggest-reforges-button-settings",children:o(u,null,o("i",{className:"fas fa-cog"}))},[r,n]=t.addActionGroup([s,i],{cssClass:"suggest-reforges-settings-group d-flex"});b(n,{content:"Change Reforge Optimizer settings"}),this.buildContextMenu(n)}get statCaps(){return this.sim.getUseCustomEPValues()?this.player.getStatCaps():this.defaults.statCaps||new i}setStatCap(t,e){return this._statCaps=this._statCaps.withStat(t,e),this.sim.getUseCustomEPValues()&&this.player.setStatCaps(r.nextEventID(),this._statCaps),this.statCaps}setDefaultStatCaps(){return this._statCaps=this.defaults.statCaps||new i,this.player.setStatCaps(r.nextEventID(),this._statCaps),this.statCaps}get preCapEPs(){let t=this.sim.getUseCustomEPValues()?this.player.getEpWeights():this.defaults.epWeights;return this.isHybridCaster&&(t=t.withStat(s.StatSpirit,.01)),t}buildContextMenu(t){const e=b(t,{interactive:!0,trigger:"click",theme:"reforge-optimiser-popover",placement:"right-start",onShow:t=>{const e=new n(null,this.player,{id:"reforge-optimizer-enable-custom-ep-weights",label:"Enable custom EP Weights",inline:!0,changedEvent:t=>t.epWeightsChangeEmitter,getValue:()=>this.sim.getUseCustomEPValues(),setValue:(t,e,s)=>{this.sim.setUseCustomEPValues(t,s)}}),s=g();t.setContent(o(u,null,e.rootElem,o("div",{ref:s,className:l("mb-0",this.sim.getUseCustomEPValues()&&"hide")},o("p",null,"This will enable modification of the default EP weights and setting custom stat caps."),o("p",null,"Ep weights can be modified in the Stat Weights editor."),o("p",{className:"mb-0"},"If you want to hard cap a stat make sure to put the EP for that stat higher.")),this.buildCapsList({input:e,description:s.value})))},onHidden:()=>{e.setContent(o(u,null))}})}buildCapsList({input:t,description:e}){const a=g(),r=g(),n=g(),u=new i(this.simUI.individualConfig.displayStats),f=o("ul",{ref:a,className:l("reforge-optimizer-stat-cap-list list-reset d-grid gap-2",!this.sim.getUseCustomEPValues()&&"hide")},o("li",{className:"d-flex"},o("label",{className:"me-1"},"Edit stat caps"),o("button",{ref:r,className:"d-inline"},o("i",{className:"fa-regular fa-circle-question"})),o("button",{ref:n,className:"d-inline ms-auto",onclick:()=>this.setDefaultStatCaps()},o("i",{className:"fas fa-arrow-rotate-left"}))),this.simUI.individualConfig.displayStats.map((t=>{if(_.includes(t))return;const e=g(),a=p(t,this.player.getClass()),i=new y(null,this.player,{id:`character-bonus-stat-${t}`,inline:!0,float:!0,showZeroes:!1,label:`${a} ${t===s.StatMastery?"Points":"%"}`,extraCssClasses:["mb-0"],changedEvent:t=>this.player.statCapsChangeEmitter,getValue:()=>c(t,this.statCaps.getStat(t),u),setValue:(e,s,a)=>{this.setStatCap(t,h(t,a,u))}});return o("li",{ref:e,className:"reforge-optimizer-stat-cap-item"},i.rootElem)})));if(r.value){const e=b(r.value,{content:"Stat caps are the maximum amount of a stat that can be gained from Reforging. If a stat exceeds its cap, the optimizer will attempt to reduce it to the cap value."});t.addOnDisposeCallback((()=>e.destroy()))}if(n.value){const e=b(n.value,{content:"Reset to stat cap defaults"});t.addOnDisposeCallback((()=>e.destroy()))}const d=this.sim.useCustomEPValuesChangeEmitter.on((()=>{const t=this.sim.getUseCustomEPValues();a.value?.classList[t?"remove":"add"]("hide"),e?.classList[t?"add":"remove"]("hide")}));return t.addOnDisposeCallback((()=>{f.remove(),d.dispose()})),f}async optimizeReforges(){const t=this.player.getGear().withoutReforges(this.player.canDualWield2H()),e=(await this.updateGear(t)).computeStatCapsDelta(this.statCaps),s=this.buildYalpsVariables(t),a=this.buildYalpsConstraints(t);await this.solveModel(t,e,s,a)}async updateGear(t){this.player.setGear(r.nextEventID(),t),await this.sim.updateCharacterStats(r.nextEventID());let e=i.fromProto(this.player.getCurrentStats().finalStats);return e=e.addStat(s.StatMastery,this.player.getBaseMastery()*f),this.updateGearStatsModifier&&(e=this.updateGearStatsModifier(e)),e}buildYalpsVariables(t){const e=new Map;for(const s of t.getItemSlots()){const a=t.getEquippedItem(s);if(a)for(const t of this.player.getAvailableReforgings(a)){const a=`${s}_${t.id}`,i=new Map;i.set(d[s],1);for(const e of t.fromStat)this.applyReforgeStat(i,e,t.fromAmount);for(const e of t.toStat)this.applyReforgeStat(i,e,t.toAmount);e.set(a,i)}}return e}applyReforgeStat(t,e,i){let r=e,n=i;if(e==s.StatSpirit&&this.isHybridCaster){switch(r=s.StatSpellHit,this.player.getSpec()){case a.SpecBalanceDruid:n*=.5*this.player.getTalents().balanceOfPower;break;case a.SpecShadowPriest:n*=.5*this.player.getTalents().twistedFaith;break;case a.SpecElementalShaman:n*=[0,.33,.66,1][this.player.getTalents().elementalPrecision]}t.set(s[e],i)}const o=t.get(s[r])||0;t.set(s[r],o+n)}buildYalpsConstraints(t){const e=new Map;for(const s of t.getItemSlots())e.set(d[s],{max:1});return e}async solveModel(t,e,s,a){const i=this.updateReforgeScores(s,a),r=U({direction:"maximize",objective:"score",constraints:a,variables:i,binaries:!0},{timeout:15e3,maxIterations:1/0,tolerance:.01});await this.applyLPSolution(t,r);const[n,o]=this.checkCaps(r,e,i,a);n&&(await m(100),await this.solveModel(t,e,i,o))}updateReforgeScores(t,e){const a=new Map;for(const[i,r]of t.entries()){let t=0;const n=new Map;for(const[a,i]of r.entries())if(n.set(a,i),a.includes("Stat")&&!e.has(a)){const e=s[a];t+=this.preCapEPs.getStat(e)*i}n.set("score",t),a.set(i,n)}return a}async applyLPSolution(t,e){let s=t.withoutReforges(this.player.canDualWield2H());for(const[a,i]of e.variables){const e=a.split("_"),i=parseInt(e[0]),r=parseInt(e[1]),n=t.getEquippedItem(i);n&&(s=s.withEquippedItem(i,n.withReforge(this.sim.db.getReforgeById(r)),this.player.canDualWield2H()))}await this.updateGear(s)}checkCaps(t,e,a,r){let n=new i;for(const[i,u]of t.variables)for(const[t,e]of a.get(i).entries())if(t.includes("Stat")){const a=s[t];n=n.addStat(a,e)}let o=!1;const l=new Map(r);for(const[i,u]of n.asArray().entries()){const t=e.getStat(i),a=s[i];0!==t&&u>t&&!r.has(a)&&(l.set(a,S(t)),o=!0)}return[o,l]}}export{H as R};
